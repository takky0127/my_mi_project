# ===============================
# SMILES â†’ 3Dæ§‹é€  â†’ 3Dè¨˜è¿°å­è‡ªå‹•ç”Ÿæˆã‚³ãƒ¼ãƒ‰
# ===============================

from rdkit import Chem
from rdkit.Chem import AllChem
from mordred import Calculator, descriptors
import pandas as pd
from tqdm import tqdm

# --- å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ï¼ˆä¾‹ï¼šè¤‡æ•°åˆ†å­ã®SMILESï¼‰ ---
smiles_list = [
    "CCO",        # ã‚¨ã‚¿ãƒãƒ¼ãƒ«
    "CC(=O)O",    # é…¢é…¸
    "c1ccccc1",   # ãƒ™ãƒ³ã‚¼ãƒ³
]

# --- Mordred è¨ˆç®—å™¨ï¼ˆ3Dè¨˜è¿°å­ã‚’å«ã‚€ï¼‰ ---
calc = Calculator(descriptors, ignore_3D=False)

# --- çµæœã‚’æ ¼ç´ã™ã‚‹ãƒªã‚¹ãƒˆ ---
results = []

# --- å„SMILESã«ã¤ã„ã¦å‡¦ç† ---
for smi in tqdm(smiles_list, desc="Calculating 3D descriptors"):
    mol = Chem.MolFromSmiles(smi)
    if mol is None:
        print(f"[Warning] Invalid SMILES: {smi}")
        continue

    # æ°´ç´ ä»˜åŠ 
    mol = Chem.AddHs(mol)

    # --- 3Dæ§‹é€ ç”Ÿæˆ ---
    status = AllChem.EmbedMolecule(mol, randomSeed=42)
    if status != 0:
        print(f"[Warning] 3D embedding failed for: {smi}")
        continue

    # --- æ§‹é€ æœ€é©åŒ–ï¼ˆMM: UFF or MMFF94ï¼‰ ---
    try:
        # UFFã¾ãŸã¯MMFFã§æ§‹é€ æœ€é©åŒ–
        if AllChem.MMFFHasAllMoleculeParams(mol):
            AllChem.MMFFOptimizeMolecule(mol)  # MMFF94
        else:
            AllChem.UFFOptimizeMolecule(mol)   # UFF fallback
    except Exception as e:
        print(f"[Warning] Optimization failed for {smi}: {e}")
        continue

    # --- Mordredè¨˜è¿°å­è¨ˆç®— ---
    try:
        desc = calc(mol)
        desc_dict = desc.asdict()
        desc_dict["SMILES"] = smi
        results.append(desc_dict)
    except Exception as e:
        print(f"[Warning] Descriptor calc failed for {smi}: {e}")

# --- DataFrameã«å¤‰æ› ---
df_desc = pd.DataFrame(results)

# --- çµæœã‚’è¡¨ç¤ºãƒ»ä¿å­˜ ---
print(f"âœ… è¨˜è¿°å­æ•°: {df_desc.shape[1]-1}")
print(f"âœ… åˆ†å­æ•°: {df_desc.shape[0]}")
df_desc.to_csv("mordred_3D_descriptors.csv", index=False)
print("ğŸ’¾ 'mordred_3D_descriptors.csv' ã«ä¿å­˜ã—ã¾ã—ãŸã€‚")
